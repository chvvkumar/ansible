---
  - hosts: all
    sudo: yes
    tasks:
      - name: Update package list
        apt: update_cache=yes
        register: apt_result

      - name: Install common packages
        apt:
          name: "{{ item }}"
          update_cache: yes
          cache_valid_time: 3600
          state: latest
        with_items:
          - git
          - python
          - python3
          - nfs-common
          - net-tools

      - name: Upgrade APT to the latest packages
        apt: upgrade=dist
        register: apt_result

      - name: Autoremove unused packages
        apt: autoremove=yes
        register: apt_result
        changed_when: "'packages will be REMOVED' in apt_result.stdout"